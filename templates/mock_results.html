{% extends 'base.html' %}

{% block content %}
  <h2 class="text-2xl font-bold mb-4">SAT Mock Test Results</h2>


  {# ===== DISPLAY ===== #}
  <!-- Score Summary -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center my-10">
  <div>
    <p class="text-lg font-semibold text-gray-800 mb-1">Predicted Score</p>
    <p class="text-5xl font-extrabold text-gray-900">{{ total_score }}</p>
  </div>
  <div>
    <p class="text-lg font-semibold text-gray-800 mb-1">Reading &amp; Writing</p>
    <p class="text-5xl font-extrabold text-gray-900">{{ verbal_score }}</p>
  </div>
  <div>
    <p class="text-lg font-semibold text-gray-800 mb-1">Mathematics</p>
    <p class="text-5xl font-extrabold text-gray-900">{{ math_score }}</p>
  </div>
</div>

<hr class="my-8 border-gray-300">


<!-- Domain Performance (100% stacked bars; data precomputed in backend) -->
<h3 class="text-xl font-bold mb-2 mt-6">Domain Performance</h3>
<p class="text-sm text-gray-600 mb-4">ผลประเมินแยกรายโดเมน</p>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white p-4 rounded shadow">
    <h4 class="font-semibold mb-2">Reading &amp; Writing</h4>
    <div style="height: 360px">
      <canvas id="verbalDomainStacked"></canvas>
    </div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h4 class="font-semibold mb-2">Mathematics</h4>
    <div style="height: 360px">
      <canvas id="mathDomainStacked"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Precomputed arrays from backend (no frontend math)
  const dc = {{ domain_chart_data|tojson }};

  function stackedBar(canvasId, labels, pctCorrect, pctIncorrect, correct, incorrect, totals) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: '% Correct',   data: pctCorrect,   stack: 'pct' },
          { label: '% Incorrect', data: pctIncorrect, stack: 'pct' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
          x: {
            beginAtZero: true,
            max: 100,
            stacked: true,
            ticks: { callback: v => v + '%' },
            title: { display: true, text: 'Percent' }
          },
          y: { stacked: true, ticks: { autoSkip: false } }
        },
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const i = ctx.dataIndex;
                const label = ctx.dataset.label;
                if (label.includes('Correct')) {
                  return `${label}: ${ctx.raw}%  (${correct[i]}/${totals[i]})`;
                } else {
                  return `${label}: ${ctx.raw}%  (${incorrect[i]}/${totals[i]})`;
                }
              }
            }
          }
        }
      }
    });
  }

  // Verbal
  stackedBar(
    'verbalDomainStacked',
    dc.verbal.labels,
    dc.verbal.pct_correct,
    dc.verbal.pct_incorrect,
    dc.verbal.correct,
    dc.verbal.incorrect,
    dc.verbal.totals
  );

  // Math
  stackedBar(
    'mathDomainStacked',
    dc.math.labels,
    dc.math.pct_correct,
    dc.math.pct_incorrect,
    dc.math.correct,
    dc.math.incorrect,
    dc.math.totals
  );
</script>


<br>

  <a href="{{ url_for('dashboard') }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Back to Dashboard</a>
{% endblock %}

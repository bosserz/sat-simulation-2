{% extends 'base.html' %}

{% block content %}
  <h2 class="text-2xl font-bold mb-4">SAT Mock Test Results</h2>


  {# ===== DISPLAY ===== #}
  <!-- Score Summary -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center my-10">
  <div>
    <p class="text-lg font-semibold text-gray-800 mb-1">Predicted Score</p>
    <p class="text-5xl font-extrabold text-gray-900">{{ total_score }}</p>
  </div>
  <div>
    <p class="text-lg font-semibold text-gray-800 mb-1">Reading &amp; Writing</p>
    <p class="text-5xl font-extrabold text-gray-900">{{ verbal_score }}</p>
  </div>
  <div>
    <p class="text-lg font-semibold text-gray-800 mb-1">Mathematics</p>
    <p class="text-5xl font-extrabold text-gray-900">{{ math_score }}</p>
  </div>
</div>

<hr class="my-8 border-gray-300">


  <!-- Domain Performance (100% stacked bars) -->
<h3 class="text-xl font-bold mb-2 mt-6">Domain Performance</h3>
<p class="text-sm text-gray-600 mb-4">Share of correct vs incorrect by domain (per section)</p>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white p-4 rounded shadow">
    <h4 class="font-semibold mb-2">Reading & Writing</h4>
    <div style="height: 360px">
      <canvas id="verbalDomainStacked"></canvas>
    </div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h4 class="font-semibold mb-2">Mathematics</h4>
    <div style="height: 360px">
      <canvas id="mathDomainStacked"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // Data from backend
  const domainStats = {{ domain_stats|tojson }};

  // Convert {domain: {correct,total}} -> sorted labels + % correct/incorrect + raw
  function prep(statsObj) {
    const rows = Object.entries(statsObj || {}).map(([domain, v]) => {
      const total = v?.total || 0;
      const correct = v?.correct || 0;
      const incorrect = Math.max(0, total - correct);
      const pCorr = total ? (100 * correct / total) : 0;
      const pInc  = total ? (100 * incorrect / total) : 0;
      return { domain, total, correct, incorrect, pCorr, pInc };
    }).sort((a, b) => a.domain.localeCompare(b.domain));

    return {
      labels: rows.map(r => r.domain),
      pCorr:  rows.map(r => Math.round(r.pCorr)),
      pInc:   rows.map(r => Math.round(r.pInc)),
      corr:   rows.map(r => r.correct),
      inc:    rows.map(r => r.incorrect),
      totals: rows.map(r => r.total),
    };
  }

  const verbal = prep(domainStats.verbal || {});
  const math   = prep(domainStats.math   || {});

  function stackedBar(canvasId, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: [
          { label: '% Correct',   data: data.pCorr, stack: 'pct' },
          { label: '% Incorrect', data: data.pInc,  stack: 'pct' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',                 // horizontal bars
        scales: {
          x: {
            beginAtZero: true,
            max: 100,
            ticks: { callback: v => v + '%' },
            stacked: true,
            title: { display: true, text: 'Percent' }
          },
          y: { stacked: true, ticks: { autoSkip: false } }
        },
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const i = ctx.dataIndex;
                const label = ctx.dataset.label;
                if (label.includes('Correct')) {
                  return `${label}: ${ctx.raw}%  (${data.corr[i]}/${data.totals[i]})`;
                } else {
                  return `${label}: ${ctx.raw}%  (${data.inc[i]}/${data.totals[i]})`;
                }
              }
            }
          }
        }
      }
    });
  }

  stackedBar('verbalDomainStacked', verbal);
  stackedBar('mathDomainStacked',   math);
</script>

<br>

  <a href="{{ url_for('dashboard') }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Back to Dashboard</a>
{% endblock %}
